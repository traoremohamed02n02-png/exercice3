name: DevSecOps Pipeline
on:
  push:
    branches: [ "main" ]
permissions:
  contents: read
  security-events: write
  actions: read
jobs:
  devsecops:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    ############################################
    # 1. Analyse SAST CodeQL
    ############################################
    - name: Init CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
    - name: Run CodeQL
      uses: github/codeql-action/analyze@v3
    ############################################
    # 2. Analyse sécurité Python avec Bandit
    ############################################
    - name: Install Bandit
      run: pip install bandit
    - name: Run Bandit
      run: bandit -r api --severity-level high
    ############################################
    # 3. Build Docker
    ############################################
    - name: Build Docker image
      run: docker build -t devsecops-api .
    ############################################
    # 4. Scan Docker avec Trivy
    ############################################
    name: Trivy Scan

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  trivy-scan:
    name: Scan Docker Image with Trivy
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupérer le code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Installer Trivy
      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1

      # 3️⃣ Mettre en cache Trivy DB
      - name: Cache Trivy DB
        uses: actions/cache@v3
        with:
          path: ~/.cache/trivy
          key: cache-trivy-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            cache-trivy-${{ runner.os }}-

      # 4️⃣ Build Docker image
      - name: Build Docker image
        run: docker build -t devsecops-api .

      # 5️⃣ Exécuter Trivy scan
      - name: Run Trivy Scan
        run: |
          trivy image --severity CRITICAL,HIGH,MEDIUM \
                      --format json \
                      --output trivy-report.json \
                      devsecops-api

      # 6️⃣ Afficher un résumé dans la console
      - name: Display Trivy Summary
        run: |
          cat trivy-report.json | jq '.Results[].Vulnerabilities[] | {VulnerabilityID, Severity, PackageName, InstalledVersion}'
